{% extends "base.html" %}
{% block title %}Analytics{% endblock %}
{% block page_title %}Analytics Dashboard{% endblock %}
{% block content %}
<div class="row g-3 mb-4">
    <div class="col-sm-6 col-lg-3">
        <div class="stat-card">
            <div class="stat-icon icon-indigo"><i class="bi bi-people-fill"></i></div>
            <div>
                <div class="stat-val">{{ total_students }}</div>
                <div class="stat-label">Total Students</div>
            </div>
        </div>
    </div>
    <div class="col-sm-6 col-lg-3">
        <div class="stat-card">
            <div class="stat-icon icon-emerald"><i class="bi bi-trophy-fill"></i></div>
            <div>
                <div class="stat-val">{{ total_placed }}</div>
                <div class="stat-label">Placed</div>
            </div>
        </div>
    </div>
    <div class="col-sm-6 col-lg-3">
        <div class="stat-card">
            <div class="stat-icon icon-amber"><i class="bi bi-percent"></i></div>
            <div>
                <div class="stat-val">{% if total_students %}{{ (total_placed/total_students*100)|round(1) }}{% else
                    %}0{% endif %}%</div>
                <div class="stat-label">Placement Rate</div>
            </div>
        </div>
    </div>
    <div class="col-sm-6 col-lg-3">
        <div class="stat-card">
            <div class="stat-icon icon-sky"><i class="bi bi-file-earmark-check"></i></div>
            <div>
                <div class="stat-val">{{ status_data | sum(attribute='count') }}</div>
                <div class="stat-label">Total Applications</div>
            </div>
        </div>
    </div>
</div>
<div class="row g-4 mb-4">
    <div class="col-lg-6">
        <div class="pp-card h-100">
            <h6 class="mb-3"
                style="color:var(--text-muted);font-size:.8rem;text-transform:uppercase;letter-spacing:.08em;">
                Branch-wise Placement</h6>
            <canvas id="branchChart" height="220"></canvas>
        </div>
    </div>
    <div class="col-lg-6">
        <div class="pp-card h-100">
            <h6 class="mb-3"
                style="color:var(--text-muted);font-size:.8rem;text-transform:uppercase;letter-spacing:.08em;">
                Application Status</h6>
            <canvas id="statusChart" height="220"></canvas>
        </div>
    </div>
</div>
<div class="row g-4">
    <div class="col-lg-5">
        <div class="pp-card h-100">
            <h6 class="mb-3"
                style="color:var(--text-muted);font-size:.8rem;text-transform:uppercase;letter-spacing:.08em;">Top
                In-Demand Skills</h6>
            {% if top_skills %}
            <div class="d-flex flex-column gap-3">
                {% set max_count = top_skills[0].count %}
                {% for sk in top_skills %}
                <div>
                    <div class="d-flex justify-content-between mb-1">
                        <span style="font-size:.83rem;font-weight:600;">{{ sk.skill }}</span>
                        <span class="note">{{ sk.count }}</span>
                    </div>
                    <div class="skill-bar">
                        <div class="skill-fill" style="width:{{ (sk.count/max_count*100)|int }}%"></div>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}<p class="note text-center py-3">No skill data.</p>{% endif %}
        </div>
    </div>
    <div class="col-lg-7">
        <div class="pp-card h-100">
            <h6 class="mb-3"
                style="color:var(--text-muted);font-size:.8rem;text-transform:uppercase;letter-spacing:.08em;">Drive
                Statistics</h6>
            {% if drive_stats %}
            <div class="table-responsive">
                <table class="pp-table">
                    <thead>
                        <tr>
                            <th>Company</th>
                            <th>Applicants</th>
                            <th>Selected</th>
                            <th>Conversion</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for d in drive_stats %}
                        <tr>
                            <td><strong>{{ d.company_name }}</strong></td>
                            <td>{{ d.applicants }}</td>
                            <td><span style="color:var(--success);font-weight:700;">{{ d.selected }}</span></td>
                            <td>
                                {% if d.applicants %}
                                {% set pct = (d.selected / d.applicants * 100)|round(1) %}
                                <div class="skill-bar"
                                    style="width:100px;display:inline-block;vertical-align:middle;margin-right:6px;">
                                    <div class="skill-fill" style="width:{{ pct }}%"></div>
                                </div>{{ pct }}%
                                {% else %}â€”{% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}<p class="note text-center py-3">No drive data yet.</p>{% endif %}
        </div>
    </div>
</div>
{% endblock %}
{% block scripts %}
<script>
    const branchLabels = {{ branch_data | map(attribute = 'branch') | list | tojson }};
    const branchVals = {{ branch_data | map(attribute = 'count') | list | tojson }};
    const statusLabels = {{ status_data | map(attribute = 'status') | list | tojson }};
    const statusVals = {{ status_data | map(attribute = 'count') | list | tojson }};
    const palette = ['#4f46e5', '#f59e0b', '#22c55e', '#38bdf8', '#ef4444', '#8b5cf6', '#f97316', '#ec4899'];
    new Chart(document.getElementById('branchChart'), {
        type: 'bar',
        data: {
            labels: branchLabels.length ? branchLabels : ['No data'],
            datasets: [{
                label: 'Placed', data: branchVals.length ? branchVals : [0],
                backgroundColor: palette, borderRadius: 6
            }]
        },
        options: {
            plugins: { legend: { display: false } },
            scales: {
                x: { ticks: { color: '#94a3b8' }, grid: { color: '#334155' } },
                y: { ticks: { color: '#94a3b8' }, grid: { color: '#334155' }, beginAtZero: true }
            }
        }
    });
    new Chart(document.getElementById('statusChart'), {
        type: 'doughnut',
        data: {
            labels: statusLabels.length ? statusLabels : ['No data'],
            datasets: [{
                data: statusVals.length ? statusVals : [1],
                backgroundColor: palette, borderColor: '#1e293b', borderWidth: 3
            }]
        },
        options: { plugins: { legend: { labels: { color: '#94a3b8', font: { size: 11 } } } }, cutout: '60%' }
    });
</script>
{% endblock %}